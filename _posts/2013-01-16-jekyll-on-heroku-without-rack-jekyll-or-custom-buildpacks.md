---
layout:    post
title:     Jekyll on Heroku without Rack::Jekyll or custom buildpacks
published: true
---

For a while now, this site has been hosted on [Heroku][] as static files
generated by [Jekyll][], which is much faster than either my old
WordPress blog or my previous Rails-based site (even with caching). Most
sets of instructions for deploying Jekyll sites to Heroku either say to
use [Rack::Jekyll][] and commit the site's compiled static files into
Git, or to use a [custom Heroku buildpack][] to compile the site at
deploy time; [GitHub Pages][] wasn't an option, either, since they don't
allow plugins and I would have to commit the compiled static files to
Git, and although I've borrowed [a few plugins][] from [Octopress][], I
wanted to start from a clean repository. Ultimately, I wanted to stick
as close to the default Heroku setup as possible without cluttering the
repository with compiled pages, and Rack::Jekyll is unnecessarily
complicated when [Rack::TryStatic works just fine][].

<!-- more -->

## Compiling on deployment

[Heroku's Ruby buildpack][] looks by default for the Rake task
`assets:precompile` and runs it if it finds it. This is typically for
the [Rails asset pipeline][] to precompile [CoffeeScript][] files,
[Compass][] stylesheets, &c., but any site that uses the Ruby buildpack
can add a task with the same name to its Rakefile and have it run every
time the site is pushed to Heroku. It turns out this is perfect for
compiling Jekyll pages:

{% gist 4551206 Rakefile %}

When Heroku builds the application slug, it installs gems into the
`vendor` directory. This can cause some strange results, most commonly
[Jekyll test posts showing up as published][]. The fix is, simply, to
[exclude the `vendor` directory in your `_config.yml`][]. As a good
general practice, make sure to build your site locally before deploying
it to make sure no files are being included in the `_site` directory
that you don't want there (`README`s, server configuration files, &c.),
but this is a quirk of the Heroku environment that in most cases won't
happen locally and needs to be accounted for.

## Serving from Rack

Once they've been compiled by Heroku, the static files are served up by
[Unicorn][] and a pair of [Rack::Contrib][] modules: `try_static` and
`not_found`. `try_static` lets Rack serve up static HTML files and
tries to match specified paths, and `not_found` tells Rack to serve a
specific file in the event of a 404 error. Add `rack_contrib` to the
`Gemfile` and write a Rackup file as follows:

{% gist 4551206 config.ru %}

Finally, create a `Procfile` with a web task for Heroku to run your
server of choice, such as Unicorn (assuming you have added `unicorn` to
your `Gemfile` and configured it appropriately):

{% gist 4551206 Procfile %}

The [entire source of this site][] is available on GitHub, so you can
see there how I've [configured Unicorn][], my [Gemfile][], &c., as a
basis for your own deployment.

**Updated 2013-02-06:** I'm now using [`jekyll-assets`][] to handle
compiling Compass and CoffeeScript files as part of Jekyll's own build
process. I've updated this post and its associated Gist to reflect this
by removing the separate commands for and references to Compass.

**Updated 2013-02-14:** Added a hint about how to keep Jekyll test posts
from appearing in a deployed site on Heroku. Thanks to [@fulligin][] for
reminding me of it, and Jason Mitchell for the original Stack Overflow
answer that provided the solution.

[Heroku]: http://www.heroku.com/
[Jekyll]: http://jekyllrb.com/
[Rack::Jekyll]: https://github.com/adaoraul/rack-jekyll
[custom Heroku buildpack]: https://github.com/mattmanning/heroku-buildpack-ruby-jekyll
[GitHub Pages]: http://pages.github.com/
[a few plugins]: https://github.com/jbhannah/jbhannah.net/tree/master/_plugins
[Octopress]: http://octopress.org/
[Rack::TryStatic works just fine]: http://mwmanning.com/2011/12/04/Jekyll-on-Heroku-Part-2.html
[Heroku's Ruby buildpack]: https://github.com/heroku/heroku-buildpack-ruby/blob/master/lib/language_pack/ruby.rb#L573
[Rails asset pipeline]: http://guides.rubyonrails.org/asset_pipeline.html
[CoffeeScript]: http://coffeescript.org/
[Compass]: http://compass-style.org/
[Jekyll test posts showing up as published]: http://stackoverflow.com/questions/12241403/jekyll-on-heroku-listing-additional-internal-posts-i-havent-created
[exclude the `vendor` directory in your _config.yml]: https://github.com/jbhannah/jbhannah.net/commit/ff5bf39e8a7e4ebc5e3031e007ee8859f97c3fb3
[Unicorn]: http://unicorn.bogomips.org/
[Rack::Contrib]: https://github.com/rack/rack-contrib
[entire source of this site]: https://github.com/jbhannah/jbhannah.net
[configured Unicorn]: https://github.com/jbhannah/jbhannah.net/blob/master/unicorn.rb
[Compass settings]: https://github.com/jbhannah/jbhannah.net/blob/master/compass.rb
[Gemfile]: https://github.com/jbhannah/jbhannah.net/blob/master/Gemfile
[`jekyll-assets`]: https://github.com/ixti/jekyll-assets
[@fulligin]: https://twitter.com/fulligin
